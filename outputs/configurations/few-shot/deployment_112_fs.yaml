apiVersion: apps/v1
kind: Deployment
metadata:
  name: performance-test
  labels:
    app: performance-test
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: performance-test
  template:
    metadata:
      labels:
        app: performance-test
    spec:
      serviceAccountName: default
      containers:
        - name: test-container
          image: alpine:3.16
          command: ["sleep", "2000"]
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8080
          env:
            - name: STARTUP_LATENCY_METRIC
              value: "startup-latency"
            - name: DEPLOYMENT_LATENCY_METRIC
              value: "deployment-create"
            - name: POD_LATENCY_METRIC
              value: "pod-delete"
          containers:
          - name: prometheus-exporter
            image: prom/node-exporter:v0.20.0
            command:
              - /bin/ash
              - -c
              - "node_exporter -collector.logging-prometheus=true --web.listen-address :8080 --path=/metrics"
            port: 8080
          volumes:
            - name: metrics-volume
              emptyDir: {}
          terminationGracePeriodSeconds: 10
      dnsPolicy: ClusterFirst
      hostNetwork: true
      containers:
        - name: log-collector
          image: logzio/kubectl-forwarder:1.2
          command:
            - logzio-kubectl-forwarder
            - --address=tcp://logzio.io:5005
            - --port=8080
          volumeMounts:
            - name: logzio-key
              secret:
                defaultMode: 200
                optional: true
                name: logzio-key
          volumeMounts:
            - name: metrics-volume
              mountPath: /metrics
          hostNetwork: true
          terminationGracePeriodSeconds: 10
      terminationGracePeriodSeconds: 10