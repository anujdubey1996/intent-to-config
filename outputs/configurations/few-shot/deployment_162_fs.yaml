apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus-operator
  labels:
    app: prometheus-operator
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prometheus-operator
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: prometheus-operator
    spec:
      serviceAccountName: my-prometheus-sa
      containers:
      - name: prometheus
        image: quay.io/prometheus/prometheus-operator-bin:v2.10.1
        env:
        - name: PROMETHEUS_RULES_URL
          value: "https://my-prometheus-config-secret"
        ports:
        - containerPort: 9090
        volumeMounts:
        - mountPath: /etc/prometheus/
          name: prometheus-config
        - mountPath: /prometheus-operated/my-prometheus-service/
          name: prometheus-operated
      - name: prometheus-adapter
        image: quay.io/prometheus/prometheus-pushgateway:v2.10.1
        ports:
        - containerPort: 9091
        volumeMounts:
        - mountPath: /metrics-push
          name: metrics-push
      - name: alertmanager
        image: quay.io/prometheus/alertmanager:v2.10.1
        env:
        - name: ALERTMANAGER_CONFIG_TARGETS
          value: "my-alertmanager-service"
        - name: ALERTMANAGER_SECRET_KEY
          value: "my-alertmanager-sa"
        ports:
        - containerPort: 9093
        volumeMounts:
        - mountPath: /etc/alertmanager/
          name: alertmanager-config
        - mountPath: /prometheus-operated/my-alertmanager-service/
          name: prometheus-operated
      - name: prometheus-kube-server
        image: quay.io/prometheus/prometheus-kube-server-adapter:v2.10.1
        env:
        - name: PROMETHEUS_OPERATOR_PROMETHEUS_URL
          value: "http://prometheus"
        ports:
        - containerPort: 9097
        volumeMounts:
        - mountPath: /kube-server/
          name: kube-server-storage
      volumes:
      - name: prometheus-config
        configMap:
          name: my-prometheus-config
      - name: prometheus-operated
        nfs:
          path: "/path/to/storage/class/nfs"
      - name: metrics-push
        emptyDir: {}
      - name: kube-server-storage
        storageClass: my-nfs-storage-class