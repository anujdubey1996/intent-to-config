apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus
  namespace: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: prometheus-service-account
rules:
- apiGroups:
  - ""
  resources:
    - pods
    - namespaces
    - nodes
    - persistentvolumeclaims
    - persistendvolumes
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - monitoring.coreos.com
  resources:
    - servicemonitors
    - alerts
    - profiles
    - rules
    - records
    - prometheusrules
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - apisix.omnichain.org
  resources:
    - routes
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - apps
  resources:
    - statefulsets
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - apps/v1
  resources:
    - deployments
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
- apiGroups:
  - batch
  resources:
    - jobs
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
- apiGroups:
  - extensions
  resources:
    - deploymentjobs
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: prometheus-service-account-role-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: prometheus-service-account
subjects:
- kind: ServiceAccount
  name: prometheus
  namespace: default
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus
  namespace: default
spec:
  serviceAccountName: prometheus
  replicas: 1
  selector:
    matchLabels:
      k8s-app: prometheus
  template:
    metadata:
      labels:
        k8s-app: prometheus
    spec:
      containers:
      - name: prometheus
        image: quay.io/prometheus/prometheus:v2.31.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 9090
        volumeMounts:
        - name: prometheus-storage
          mountPath: /etc/prometheus
        - name: prometheus-tmp
          mountPath: /tmp
      volumes:
      - name: prometheus-storage
        persistentVolumeClaim:
          claimName: prometheus-storage-claim
      - name: prometheus-tmp
        emptyDir: {}
status: {}

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: prometheus-storage-claim
  storageClass: nfs
  accessModes:
  - ReadWriteMany
reclaimPolicy: Retain
volumeName: prometheus-storage
---