apiVersion: apps/v1
kind: Deployment
metadata:
  name: instascan-vault
  labels:
    app: instascan-vault
spec:
  selector:
    matchLabels:
      app: instascan-vault
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
      updateStrategy:
        type: RollingUpdate
        rollingUpdate:
          maxUnavailable: 1
          maxSurge: 1
          updateAction:
            type: RollingUpdate
            rollingUpdate:
              preRollActionPodsMaxUnavailability: 0
              preRollActionSecondsDelay: 5
              postRollActionPodsMaxUnavailability: 1
          prepareAction:
            type: RollingUpdate
            rollingUpdate:
              preRollActionPodsMaxUnavailability: 1
              preRollActionSecondsDelay: 30
  template:
    metadata:
      labels:
        app: instascan-vault
        role: instascan-vault
    spec:
      serviceAccountName: vault-sa
      containers:
        - name: instascan-vault
          image: docker.io/instascan/instascan-vault:v1.0.0
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 3000
            - name: db
              containerPort: 5432
          env:
            - name: INSTASCAN_Vault_DB_HOST
              value: postgresql # or the service name of the PostgreSQL instance if it is available as a service
            - name: POSTGRESQL_USER
              value: scannerdb
            - name: POSTGRESQL_PASSWORD
              value: scannerdbpwd
            - name: POSTGRESQL_DATABASE
              value: scannerdb
            - name: Vault_ADDR
              value: http://vault:8000
            - name: Vault_TOKEN
              value: ${VAULT_TOKEN}
          readinessProbe:
            httpGet:
              path: /health
              port: 3000
          livenessProbe:
            httpGet:
              path: /health
              port: 3000
          startupProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - /scripts/init.sh
          securityContext:
            privileged: true
            runtimePermissions:
            - apiGroups: [""]
              resources:
                - secrets
              verbs: ["get", "list"]
            - apiGroups: [""]
              resources:
                - configmaps
              verbs: ["get", "list"]
            - apiGroups: [""]
              resources:
                - pods/<instascan-vault>
              verbs: ["get"]
      volumes:
        - name: scanner-config
          configMap:
            name: instascan-vault-config
        - name: scanner-secrets
          secret:
            secretName: instascan-vault-secrets

  ---
  kind: Service
  apiVersion: v1
  metadata:
    name: instascan-vault
    labels:
      app: instascan-vault
  spec:
    selector:
      app: instascan-vault
    ports:
      - name: http
        port: 80
        targetPort: 3000
    type: ClusterIP