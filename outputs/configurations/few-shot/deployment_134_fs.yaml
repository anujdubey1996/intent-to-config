apiVersion: apps/v1
kind: Deployment
metadata:
  name: airbyte-docker
  namespace: airbyte
spec:
  selector:
    matchLabels:
      app: airbyte-docker
  replicas: 1
  template:
    metadata:
      labels:
        app: airbyte-docker
    spec:
      NodeSelector:
        node-role.kubernetes.io/worker: true
      containers:
      - name: airbyte-api-server
        image: airbyte/airbyte-api-server:latest
        ports:
        - containerPort: 8080
        env:
          - name: AIRBYTE_API_KEY
            valueFrom:
              secretKeyRef:
                name: airbyte-apitoken
                key: apiToken
          - name: HOST_NAME
            value: airbyte-api-server
          - name: DB_URI
            valueFrom:
              configMapKeyRef:
                name: airbyte-postgres-data
                key: db-uri
      resources: # Container resources (Limits, requests)
        limits:
          memory: "512Mi"
          cpu: "2"
        requests:
          memory: "256Mi"
          cpu: "1"
status: {}

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: airbyte-worker
  namespace: airbyte
spec:
  selector:
    matchLabels:
      app: airbyte-worker
  replicas: 1
  template:
    metadata:
      labels:
        app: airbyte-worker
    spec:
      NodeSelector:
        node-role.kubernetes.io/worker: true
      containers:
      - name: airbyte-worker
        image: airbyte/airbyte-worker:latest
        env:
          - name: AIRBYTE_API_KEY
            valueFrom:
              secretKeyRef:
                name: airbyte-apitoken
                key: apiToken
          - name: JOB_ID
            value: your-job-id
          - name: DB_URI
            valueFrom:
              configMapKeyRef:
                name: airbyte-postgres-data
                key: db-uri
      resources:  # Container resources (Limits, requests)
        limits:
          memory: "512Mi"
          cpu: "2"
        requests:
          memory: "256Mi"
          cpu: "1"
status: {}

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: airbyte-postgres
  namespace: airbyte
spec:
  selector:
    matchLabels:
      app: airbyte-postgres
  replicas: 1
  template:
    metadata:
      labels:
        app: airbyte-postgres
    spec:
      containers:
      - name: airbyte-postgres
        image: postgres:12
        env:
          - name: POSTGRES_USER
            value: postgres
          - name: POSTGRES_PASSWORD
            value: password
        volumeClaimTemplate:
          storageClassName: standard
          resources:
            requests:
              storage: 10Gi
        ports:
        - containerPort: 5432
status: {}

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: airbyte-monitoring
  namespace: airbyte
spec:
  selector:
    matchLabels:
      app: airbyte-monitoring
  replicas: 1
  template:
    metadata:
      labels:
        app: airbyte-monitoring
    spec:
      containers:
      - name: airbyte-monitoring
        image: prom/kubernetes-prometheus-operator:latest
        env:
          - name: K8S_PROMETHEUS_PROTESTER_E2E_K8S_PROVIDER
            value: "kubernetes"
        ports:
        - containerPort: 9090
        - containerPort: 30800
        arguments:
          - --component-config-file=-
        volumeClaimTemplate:
          storageClassName: standard
          resources:
            requests:
              storage: 10Gi
status: {}